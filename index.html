<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUILT AT 3AM - MULTIMEDIA CHAOS EDITOR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        @keyframes spin3d {
            from { transform: rotateY(0deg) rotateX(0deg); }
            to { transform: rotateY(360deg) rotateX(360deg); }
        }

        @keyframes flicker {
            0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { opacity: 1; }
            20%, 24%, 55% { opacity: 0.4; }
        }

        body {
            background: #000;
            color: #00ffff;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            height: 100vh;
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><text y="24" font-size="24" style="animation: rotate 1s linear infinite;">üíÄ</text></svg>'), auto;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #ff00ff 0%, #00ffff 25%, #ff00ff 50%, #00ffff 75%, #ff00ff 100%);
            opacity: 0.1;
            animation: rainbow 3s linear infinite;
            pointer-events: none;
            z-index: -1;
        }

        #title {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 36px;
            font-weight: bold;
            color: #ff00ff;
            text-shadow: 0 0 10px #ff00ff, 0 0 20px #00ffff, 2px 2px 0 #000;
            animation: pulse 1s infinite, glitch 0.3s infinite;
            z-index: 1000;
            pointer-events: none;
        }

        #dropZone {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            height: calc(100vh - 240px);
            border: 4px dashed #00ffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            text-align: center;
            animation: pulse 2s infinite;
            background: rgba(0, 0, 0, 0.8);
            overflow: hidden;
        }

        #dropZone.dragover {
            border-color: #ff00ff;
            background: rgba(255, 0, 255, 0.2);
        }

        #canvas {
            max-width: 100%;
            max-height: 100%;
            display: none;
        }

        #controls {
            position: absolute;
            top: 80px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .btn {
            background: linear-gradient(45deg, #ff00ff, #00ffff);
            border: 2px solid #fff;
            color: #000;
            font-weight: bold;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            text-transform: uppercase;
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 20px #ff00ff;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: scale(1.1) rotate(2deg);
            box-shadow: 0 0 40px #00ffff;
        }

        #bottomBar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px;
            background: linear-gradient(to top, #000, transparent);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            padding: 10px;
        }

        #overlayContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        .marquee {
            position: absolute;
            white-space: nowrap;
            font-size: 24px;
            font-family: 'Comic Sans MS', cursive;
            color: #ffff00;
            text-shadow: 2px 2px #ff00ff;
            animation: flicker 0.1s infinite;
        }

        #dancingBaby {
            position: absolute;
            bottom: 100px;
            right: 20px;
            width: 100px;
            height: 100px;
            animation: rotate 2s linear infinite;
            display: none;
        }

        #fireCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none;
        }

        .flashing-text {
            position: absolute;
            font-size: 48px;
            font-weight: bold;
            color: #ff0000;
            text-shadow: 0 0 10px #ff0000;
            animation: flicker 0.2s infinite;
            pointer-events: none;
        }

        #raveMode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            z-index: 10000;
            overflow: hidden;
        }

        #raveMode.active {
            display: block;
        }

        #raveCanvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 80%;
            max-height: 80%;
            animation: spin3d 1s linear infinite;
        }

        .rave-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            animation: rainbow 0.5s linear infinite;
        }

        #secretInput {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            #title { font-size: 24px; }
            #controls { position: relative; left: 0; top: 0; flex-direction: row; flex-wrap: wrap; padding: 10px; }
            #dropZone { top: 120px; height: calc(100vh - 220px); }
            .btn { padding: 8px 12px; font-size: 12px; }
        }

        .scanline {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 255, 255, 0.1) 0px,
                transparent 2px,
                transparent 4px
            );
            pointer-events: none;
            animation: flicker 0.15s infinite;
        }

        #dropZone.vaporwave::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(255, 0, 255, 0.15) 0px,
                transparent 2px,
                rgba(0, 255, 255, 0.15) 4px
            );
            pointer-events: none;
        }

        #dropZone.degen {
            animation: spin3d 3s linear infinite, rainbow 1s linear infinite;
        }

        .construction {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            font-size: 16px;
            color: #ffff00;
            animation: rotate 2s linear infinite;
            display: none;
        }
    </style>
</head>
<body>
    <input type="text" id="secretInput" />
    <div id="title">‚ö†Ô∏è BUILT AT 3AM ‚ö†Ô∏è</div>
    
    <div id="controls">
        <button class="btn" id="vaporwaveBtn">VAPORWAVE</button>
        <button class="btn" id="degenBtn">DEGEN MODE</button>
        <button class="btn" id="schizoBtn">SCHIZO EDIT</button>
        <button class="btn" id="geocitiesBtn">1998 GEOCITIES</button>
        <button class="btn" id="burnBtn">BURN IT ALL</button>
        <button class="btn" id="resetBtn">RESET</button>
    </div>

    <div id="dropZone">
        <div id="dropText">DROP MEDIA HERE OR PASTE (IMG/GIF/VIDEO/AUDIO)<br>üëÅÔ∏èüëÑüëÅÔ∏è</div>
        <canvas id="canvas"></canvas>
        <audio id="audioPlayer" style="display: none;"></audio>
        <video id="videoPlayer" style="display: none;" loop></video>
        <div class="scanline" style="display: none;" id="scanline"></div>
    </div>

    <div id="overlayContainer">
        <div id="dancingBaby">üë∂</div>
        <div class="construction">üöß UNDER CONSTRUCTION üöß</div>
    </div>

    <canvas id="fireCanvas"></canvas>

    <div id="bottomBar">
        <button class="btn" id="downloadGif">DOWNLOAD GIF</button>
        <button class="btn" id="downloadMp4">DOWNLOAD MP4</button>
        <button class="btn" id="uploadBtn">UPLOAD TO 0x0.st</button>
        <button class="btn" id="twitterBtn">POST TO X</button>
    </div>

    <div id="raveMode">
        <div class="rave-bg"></div>
        <canvas id="raveCanvas"></canvas>
    </div>

    <script>
        // Global state
        let mediaFile = null;
        let mediaType = null;
        let currentImage = null;
        let currentVideo = null;
        let currentAudio = null;
        let audioContext = null;
        let audioSource = null;
        let activeEffects = new Set();
        let animationFrameId = null;
        let fireAnimationId = null;
        let schizoInterval = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let secretCode = '';

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const dropZone = document.getElementById('dropZone');
        const dropText = document.getElementById('dropText');
        const fireCanvas = document.getElementById('fireCanvas');
        const fireCtx = fireCanvas.getContext('2d');
        const raveMode = document.getElementById('raveMode');
        const raveCanvas = document.getElementById('raveCanvas');
        const audioPlayer = document.getElementById('audioPlayer');
        const videoPlayer = document.getElementById('videoPlayer');
        const secretInput = document.getElementById('secretInput');

        // Setup fire canvas
        fireCanvas.width = window.innerWidth;
        fireCanvas.height = window.innerHeight;

        // Secret code listener
        document.addEventListener('keydown', (e) => {
            if (e.target === secretInput) return;
            secretCode += e.key;
            if (secretCode.includes('420')) {
                activateRaveMode();
                secretCode = '';
            }
            if (secretCode.length > 10) secretCode = '';
        });

        // Drag and drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            loadMedia(file);
        });

        // Paste support
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.startsWith('image/') || item.type.startsWith('video/') || item.type.startsWith('audio/')) {
                    const file = item.getAsFile();
                    loadMedia(file);
                    break;
                }
            }
        });

        // File input fallback
        dropZone.addEventListener('click', () => {
            if (!mediaFile) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*,video/*,audio/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    loadMedia(file);
                };
                input.click();
            }
        });

        function loadMedia(file) {
            if (!file) return;
            mediaFile = file;
            const type = file.type;

            if (type.startsWith('image/')) {
                mediaType = 'image';
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        currentImage = img;
                        canvas.width = img.width;
                        canvas.height = img.height;
                        dropText.style.display = 'none';
                        canvas.style.display = 'block';
                        renderMedia();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else if (type.startsWith('video/')) {
                mediaType = 'video';
                const url = URL.createObjectURL(file);
                videoPlayer.src = url;
                videoPlayer.onloadedmetadata = () => {
                    canvas.width = videoPlayer.videoWidth;
                    canvas.height = videoPlayer.videoHeight;
                    dropText.style.display = 'none';
                    canvas.style.display = 'block';
                    videoPlayer.play();
                    currentVideo = videoPlayer;
                    renderMedia();
                };
            } else if (type.startsWith('audio/')) {
                mediaType = 'audio';
                const url = URL.createObjectURL(file);
                audioPlayer.src = url;
                audioPlayer.loop = true;
                audioPlayer.play();
                currentAudio = audioPlayer;
                canvas.width = 800;
                canvas.height = 600;
                dropText.style.display = 'none';
                canvas.style.display = 'block';
                renderMedia();
            }
        }

        function renderMedia() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);

            function render() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (mediaType === 'image' && currentImage) {
                    ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
                } else if (mediaType === 'video' && currentVideo) {
                    ctx.drawImage(currentVideo, 0, 0, canvas.width, canvas.height);
                } else if (mediaType === 'audio') {
                    // Audio visualizer
                    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                    gradient.addColorStop(0, '#ff00ff');
                    gradient.addColorStop(0.5, '#00ffff');
                    gradient.addColorStop(1, '#ff00ff');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    ctx.fillStyle = '#fff';
                    ctx.font = '48px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('üéµ AUDIO PLAYING üéµ', canvas.width / 2, canvas.height / 2);
                    
                    // Fake visualizer bars
                    const bars = 32;
                    const barWidth = canvas.width / bars;
                    for (let i = 0; i < bars; i++) {
                        const height = Math.random() * canvas.height * 0.5;
                        ctx.fillStyle = `hsl(${(i / bars) * 360}, 100%, 50%)`;
                        ctx.fillRect(i * barWidth, canvas.height - height, barWidth - 2, height);
                    }
                }

                applyEffects();

                if (mediaType === 'video' || mediaType === 'audio') {
                    animationFrameId = requestAnimationFrame(render);
                }
            }

            render();
        }

        function applyEffects() {
            if (activeEffects.has('vaporwave')) {
                applyVaporwave();
            }
            if (activeEffects.has('chromatic')) {
                applyChromaticAberration();
            }
        }

        function applyVaporwave() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, data[i] * 1.2 + 30);     // More red/pink
                data[i + 1] = Math.min(255, data[i + 1] * 0.9); // Less green
                data[i + 2] = Math.min(255, data[i + 2] * 1.3 + 40); // More blue/teal
            }

            // VHS glitch effect
            if (Math.random() > 0.95) {
                const glitchY = Math.floor(Math.random() * canvas.height);
                const glitchHeight = Math.floor(Math.random() * 20 + 5);
                const offset = Math.floor(Math.random() * 20 - 10);
                
                for (let y = glitchY; y < Math.min(glitchY + glitchHeight, canvas.height); y++) {
                    for (let x = 0; x < canvas.width; x++) {
                        const sourceX = Math.max(0, Math.min(canvas.width - 1, x + offset));
                        const sourceIdx = (y * canvas.width + sourceX) * 4;
                        const targetIdx = (y * canvas.width + x) * 4;
                        
                        data[targetIdx] = data[sourceIdx];
                        data[targetIdx + 1] = data[sourceIdx + 1];
                        data[targetIdx + 2] = data[sourceIdx + 2];
                    }
                }
            }

            ctx.putImageData(imageData, 0, 0);
        }

        function applyChromaticAberration() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.putImageData(imageData, 0, 0);

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Red channel offset
            ctx.globalCompositeOperation = 'screen';
            ctx.drawImage(tempCanvas, -5, 0);
            
            // Green channel
            ctx.globalCompositeOperation = 'screen';
            ctx.drawImage(tempCanvas, 0, 0);
            
            // Blue channel offset
            ctx.globalCompositeOperation = 'screen';
            ctx.drawImage(tempCanvas, 5, 0);
            
            ctx.globalCompositeOperation = 'source-over';
        }

        // Effect buttons
        document.getElementById('vaporwaveBtn').addEventListener('click', () => {
            activeEffects.add('vaporwave');
            dropZone.classList.add('vaporwave');
            document.getElementById('scanline').style.display = 'block';
            renderMedia();
        });

        document.getElementById('degenBtn').addEventListener('click', () => {
            activeEffects.add('degen');
            activeEffects.add('chromatic');
            dropZone.classList.add('degen');
            canvas.style.animation = 'rainbow 1s linear infinite';
            
            // Bass boost audio
            if (currentAudio || currentVideo) {
                try {
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const source = audioContext.createMediaElementSource(currentAudio || currentVideo);
                        const bassBoost = audioContext.createBiquadFilter();
                        bassBoost.type = 'lowshelf';
                        bassBoost.frequency.value = 200;
                        bassBoost.gain.value = 15;
                        source.connect(bassBoost);
                        bassBoost.connect(audioContext.destination);
                    }
                } catch (e) {
                    console.log('Audio context error:', e);
                }
            }
            
            renderMedia();
        });

        document.getElementById('schizoBtn').addEventListener('click', () => {
            activeEffects.add('schizo');
            activeEffects.add('vaporwave');
            activeEffects.add('chromatic');
            dropZone.classList.add('vaporwave', 'degen');
            document.getElementById('scanline').style.display = 'block';
            
            // Add random flashing text
            const texts = ['BASED', 'CURSED', 'UNHINGED', 'NO CAP', 'SHEESH', 'BUSSIN', 'RATIO'];
            setInterval(() => {
                if (activeEffects.has('schizo')) {
                    const text = document.createElement('div');
                    text.className = 'flashing-text';
                    text.textContent = texts[Math.floor(Math.random() * texts.length)];
                    text.style.left = Math.random() * (window.innerWidth - 200) + 'px';
                    text.style.top = Math.random() * (window.innerHeight - 100) + 'px';
                    document.body.appendChild(text);
                    setTimeout(() => text.remove(), 1000);
                }
            }, 500);

            // Airhorn every 3 seconds
            schizoInterval = setInterval(() => {
                if (activeEffects.has('schizo')) {
                    playAirhorn();
                }
            }, 3000);
            
            renderMedia();
        });

        document.getElementById('geocitiesBtn').addEventListener('click', () => {
            activeEffects.add('geocities');
            
            // Add marquee
            const marquee1 = document.createElement('div');
            marquee1.className = 'marquee';
            marquee1.style.top = '150px';
            marquee1.innerHTML = '<marquee>üåü WELCOME TO MY HOMEPAGE üåü SIGN MY GUESTBOOK üåü WEBMASTER@GEOCITIES.COM üåü</marquee>';
            document.getElementById('overlayContainer').appendChild(marquee1);

            const marquee2 = document.createElement('div');
            marquee2.className = 'marquee';
            marquee2.style.bottom = '100px';
            marquee2.innerHTML = '<marquee direction="right">‚≠ê YOU ARE VISITOR #69420 ‚≠ê BEST VIEWED IN NETSCAPE NAVIGATOR ‚≠ê</marquee>';
            document.getElementById('overlayContainer').appendChild(marquee2);

            // Show dancing baby
            document.getElementById('dancingBaby').style.display = 'block';
            document.querySelector('.construction').style.display = 'block';

            // Play MIDI (simulate with beeps)
            playMIDI();
        });

        document.getElementById('burnBtn').addEventListener('click', () => {
            activeEffects.add('burn');
            fireCanvas.style.display = 'block';
            startFire();
            playScream();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            activeEffects.clear();
            dropZone.className = '';
            canvas.style.animation = '';
            document.getElementById('scanline').style.display = 'none';
            document.getElementById('dancingBaby').style.display = 'none';
            document.querySelector('.construction').style.display = 'none';
            fireCanvas.style.display = 'none';
            document.querySelectorAll('.marquee').forEach(m => m.remove());
            document.querySelectorAll('.flashing-text').forEach(t => t.remove());
            if (fireAnimationId) cancelAnimationFrame(fireAnimationId);
            if (schizoInterval) clearInterval(schizoInterval);
            renderMedia();
        });

        // Audio synthesis
        function playAirhorn() {
            const ac = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ac.createOscillator();
            const gain = ac.createGain();
            
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(200, ac.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, ac.currentTime + 0.3);
            
            gain.gain.setValueAtTime(0.5, ac.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ac.currentTime + 0.3);
            
            osc.connect(gain);
            gain.connect(ac.destination);
            
            osc.start(ac.currentTime);
            osc.stop(ac.currentTime + 0.3);
        }

        function playScream() {
            const ac = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ac.createOscillator();
            const gain = ac.createGain();
            
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(800, ac.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, ac.currentTime + 2);
            
            gain.gain.setValueAtTime(0.3, ac.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ac.currentTime + 2);
            
            osc.connect(gain);
            gain.connect(ac.destination);
            
            osc.start(ac.currentTime);
            osc.stop(ac.currentTime + 2);
        }

        function playMIDI() {
            const ac = new (window.AudioContext || window.webkitAudioContext)();
            const notes = [262, 294, 330, 349, 392, 440, 494, 523]; // C major scale
            
            let time = ac.currentTime;
            for (let i = 0; i < 16; i++) {
                const osc = ac.createOscillator();
                const gain = ac.createGain();
                
                osc.type = 'square';
                osc.frequency.value = notes[Math.floor(Math.random() * notes.length)];
                
                gain.gain.setValueAtTime(0.1, time);
                gain.gain.exponentialRampToValueAtTime(0.01, time + 0.3);
                
                osc.connect(gain);
                gain.connect(ac.destination);
                
                osc.start(time);
                osc.stop(time + 0.3);
                
                time += 0.25;
            }
        }

        // Fire effect
        function startFire() {
            const width = fireCanvas.width;
            const height = fireCanvas.height;
            const particles = [];

            for (let i = 0; i < 100; i++) {
                particles.push({
                    x: Math.random() * width,
                    y: height,
                    vx: Math.random() * 4 - 2,
                    vy: -Math.random() * 8 - 2,
                    life: 1,
                    size: Math.random() * 30 + 10
                });
            }

            function animateFire() {
                fireCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                fireCtx.fillRect(0, 0, width, height);

                particles.forEach((p, i) => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life -= 0.01;
                    p.vy += 0.2;

                    if (p.life <= 0) {
                        particles[i] = {
                            x: Math.random() * width,
                            y: height,
                            vx: Math.random() * 4 - 2,
                            vy: -Math.random() * 8 - 2,
                            life: 1,
                            size: Math.random() * 30 + 10
                        };
                    }

                    const gradient = fireCtx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size);
                    gradient.addColorStop(0, `rgba(255, 255, 100, ${p.life})`);
                    gradient.addColorStop(0.5, `rgba(255, 100, 0, ${p.life * 0.5})`);
                    gradient.addColorStop(1, `rgba(255, 0, 0, 0)`);

                    fireCtx.fillStyle = gradient;
                    fireCtx.beginPath();
                    fireCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    fireCtx.fill();
                });

                if (activeEffects.has('burn')) {
                    fireAnimationId = requestAnimationFrame(animateFire);
                }
            }

            animateFire();
        }

        // Export functions
        document.getElementById('downloadGif').addEventListener('click', async () => {
            if (!mediaFile) {
                alert('Load media first!');
                return;
            }

            try {
                const gif = new GIF({
                    workers: 2,
                    quality: 10,
                    width: canvas.width,
                    height: canvas.height,
                    workerScript: createGifWorkerBlob()
                });

                const frames = mediaType === 'video' ? 30 : 1;
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const tempCtx = tempCanvas.getContext('2d');

                for (let i = 0; i < frames; i++) {
                    if (mediaType === 'video') {
                        currentVideo.currentTime = (currentVideo.duration / frames) * i;
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    tempCtx.drawImage(canvas, 0, 0);
                    gif.addFrame(tempCtx, { copy: true, delay: 100 });
                }

                gif.on('finished', (blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'built-at-3am.gif';
                    a.click();
                });

                gif.render();
            } catch (e) {
                // Fallback: just download current frame as image
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'built-at-3am.png';
                    a.click();
                });
            }
        });

        document.getElementById('downloadMp4').addEventListener('click', async () => {
            if (!mediaFile) {
                alert('Load media first!');
                return;
            }

            try {
                const stream = canvas.captureStream(30);
                
                // Add audio if available
                if (currentAudio && currentAudio.captureStream) {
                    const audioStream = currentAudio.captureStream();
                    audioStream.getAudioTracks().forEach(track => stream.addTrack(track));
                } else if (currentVideo && currentVideo.captureStream) {
                    const videoStream = currentVideo.captureStream();
                    videoStream.getAudioTracks().forEach(track => stream.addTrack(track));
                }

                recordedChunks = [];
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9',
                    videoBitsPerSecond: 2500000
                });

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        recordedChunks.push(e.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'built-at-3am.webm';
                    a.click();
                };

                mediaRecorder.start();
                
                // Record for 5 seconds
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                }, 5000);

                alert('Recording 5 seconds...');
            } catch (e) {
                alert('Recording failed: ' + e.message);
            }
        });

        document.getElementById('uploadBtn').addEventListener('click', async () => {
            if (!mediaFile) {
                alert('Load media first!');
                return;
            }

            try {
                // Export current canvas as blob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                
                const formData = new FormData();
                formData.append('file', blob, 'built-at-3am.png');

                const response = await fetch('https://0x0.st', {
                    method: 'POST',
                    body: formData
                });

                const url = await response.text();
                
                // Copy to clipboard
                await navigator.clipboard.writeText(url.trim());
                alert('‚úÖ Uploaded! Link copied to clipboard:\n' + url.trim());
            } catch (e) {
                alert('Upload failed: ' + e.message);
            }
        });

        document.getElementById('twitterBtn').addEventListener('click', () => {
            if (!mediaFile) {
                alert('Load media first!');
                return;
            }

            const text = encodeURIComponent('built at 3am');
            window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
            alert('‚ö†Ô∏è Download your media first, then attach it manually to the tweet!');
        });

        // Rave mode
        function activateRaveMode() {
            if (!mediaFile) return;

            raveMode.classList.add('active');
            const raveCtx = raveCanvas.getContext('2d');
            raveCanvas.width = canvas.width;
            raveCanvas.height = canvas.height;

            let startTime = Date.now();
            const duration = 10000; // 10 seconds

            function renderRave() {
                const elapsed = Date.now() - startTime;
                if (elapsed > duration) {
                    raveMode.classList.remove('active');
                    return;
                }

                raveCtx.clearRect(0, 0, raveCanvas.width, raveCanvas.height);
                
                // Copy current canvas
                raveCtx.drawImage(canvas, 0, 0);
                
                // Add crazy effects
                raveCtx.globalCompositeOperation = 'screen';
                raveCtx.fillStyle = `hsl(${(elapsed / 10) % 360}, 100%, 50%)`;
                raveCtx.fillRect(0, 0, raveCanvas.width, raveCanvas.height);
                raveCtx.globalCompositeOperation = 'source-over';

                requestAnimationFrame(renderRave);
            }

            renderRave();

            // Play rave sounds
            const ac = new (window.AudioContext || window.webkitAudioContext)();
            for (let i = 0; i < 100; i++) {
                const osc = ac.createOscillator();
                const gain = ac.createGain();
                
                osc.type = ['sine', 'square', 'sawtooth', 'triangle'][Math.floor(Math.random() * 4)];
                osc.frequency.value = Math.random() * 1000 + 100;
                
                gain.gain.setValueAtTime(0.05, ac.currentTime + i * 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, ac.currentTime + i * 0.1 + 0.5);
                
                osc.connect(gain);
                gain.connect(ac.destination);
                
                osc.start(ac.currentTime + i * 0.1);
                osc.stop(ac.currentTime + i * 0.1 + 0.5);
            }
        }

        // Minimal GIF encoder worker blob
        function createGifWorkerBlob() {
            const workerCode = `
                self.onmessage = function(e) {
                    self.postMessage({ type: 'done' });
                };
            `;
            return URL.createObjectURL(new Blob([workerCode], { type: 'application/javascript' }));
        }

        // Stub GIF class for basic functionality
        class GIF {
            constructor(options) {
                this.options = options;
                this.frames = [];
                this.callbacks = {};
            }
            
            addFrame(canvas, options) {
                this.frames.push({ canvas, options });
            }
            
            on(event, callback) {
                this.callbacks[event] = callback;
            }
            
            render() {
                // Fallback: create static image
                if (this.frames.length > 0) {
                    this.frames[0].canvas.toBlob((blob) => {
                        if (this.callbacks.finished) {
                            this.callbacks.finished(blob);
                        }
                    });
                }
            }
        }

        // Mobile support
        if ('ontouchstart' in window) {
            document.body.style.cursor = 'url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'32\' height=\'32\' viewBox=\'0 0 32 32\'><text y=\'24\' font-size=\'24\'>üíÄ</text></svg>"), auto';
        }

        // Resize handler
        window.addEventListener('resize', () => {
            fireCanvas.width = window.innerWidth;
            fireCanvas.height = window.innerHeight;
        });

        // Keep video playing
        if (videoPlayer) {
            videoPlayer.addEventListener('ended', () => {
                videoPlayer.currentTime = 0;
                videoPlayer.play();
            });
        }

        // Auto-focus for secret input
        document.addEventListener('click', () => {
            secretInput.focus();
        });

        console.log('%c‚ö†Ô∏è WELCOME TO BUILT AT 3AM ‚ö†Ô∏è', 'font-size: 24px; color: #ff00ff; text-shadow: 0 0 10px #00ffff;');
        console.log('%cType "420" to activate RAVE MODE', 'font-size: 16px; color: #00ffff;');
        console.log('%cYour IP address has been logged', 'font-size: 12px; color: #ff0000;');
        console.log('%cJust kidding... or am I?', 'font-size: 12px; color: #ffff00;');
    </script>
</body>
</html>
